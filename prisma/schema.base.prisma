// This is your Prisma schema file
// https://pris.ly/d/prisma-schema
// DO NOT EDIT THIS FILE DIRECTLY - it's generated from schema.base.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "__DB_PROVIDER__"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id            String               @id @default(uuid())
  email         String               @unique
  password      String
  name          String
  timezone      String               @default("America/New_York")
  children      ChildCaregiver[]
  refreshTokens RefreshToken[]
  webAuthnCredentials WebAuthnCredential[]
  pushSubscriptions PushSubscription[]
  // Sleep sessions logged by this user
  sessionsCreated SleepSession[]     @relation("SessionCreator")
  sessionsUpdated SleepSession[]     @relation("SessionUpdater")
  // Store current WebAuthn challenge for verification (temporary, cleared after use)
  webAuthnChallenge String?
  webAuthnChallengeExpiry DateTime?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// ============================================
// WebAuthn Credentials (Face ID, Touch ID, etc.)
// ============================================

model WebAuthnCredential {
  id                  String   @id @default(uuid())
  userId              String
  credentialId        String   @unique // Base64URL encoded credential ID
  credentialPublicKey String   // Base64URL encoded public key
  counter             Int      @default(0) // Signature counter for replay protection
  deviceType          String   // "platform" (Face ID, Touch ID) or "cross-platform" (security key)
  backedUp            Boolean  @default(false) // Whether credential is backed up (e.g., iCloud Keychain)
  transports          String?  // JSON array of transports: ["internal", "hybrid", etc.]
  friendlyName        String?  // User-provided name like "iPhone Face ID"
  lastUsedAt          DateTime?
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
  @@index([credentialId])
}

// ============================================
// Push Notification Subscriptions
// ============================================

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique // Push service endpoint URL
  p256dh    String   // Public key for encryption
  auth      String   // Auth secret for encryption
  // Device info for debugging/management
  userAgent String?
  // When the subscription was last used successfully
  lastUsedAt DateTime?
  // Track failed delivery attempts
  failCount  Int      @default(0)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([endpoint])
}

// ============================================
// Child Management
// ============================================

model Child {
  id          String              @id @default(uuid())
  name        String
  birthDate   DateTime
  photoUrl    String?
  caregivers  ChildCaregiver[]
  schedules   SleepSchedule[]
  sessions    SleepSession[]
  transitions ScheduleTransition[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model ChildCaregiver {
  id             String   @id @default(uuid())
  childId        String
  userId         String
  // Role: ADMIN, CAREGIVER, VIEWER
  role           String   @default("CAREGIVER")
  // InviteStatus: PENDING, ACCEPTED, DECLINED
  status         String   @default("PENDING")
  // Title: Dad, Mom, Babysitter, Sleep Coach, Grandparent, etc.
  title          String?
  // Is this caregiver's access currently active? (for temp disable)
  isActive       Boolean  @default(true)
  // Who invited this caregiver
  invitedByUserId String?
  // Email the invite was sent to (for tracking)
  inviteEmail    String?
  invitedAt      DateTime @default(now())
  acceptedAt     DateTime?
  // When access was last enabled/disabled
  accessChangedAt DateTime?
  child          Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([childId, userId])
  @@index([userId])
  @@index([childId])
  @@index([childId, isActive])
}

// Role values: ADMIN, CAREGIVER, VIEWER
// - ADMIN: Full control - can edit, delete, share
// - CAREGIVER: Can track sleep, view history
// - VIEWER: Read-only access

// InviteStatus values: PENDING, ACCEPTED, DECLINED

// Title values (suggested): Dad, Mom, Babysitter, Sleep Coach, Grandparent, Nanny, Au Pair

// ============================================
// Sleep Schedule Configuration
// ============================================

model SleepSchedule {
  id              String   @id @default(uuid())
  childId         String
  // ScheduleType: THREE_NAP, TWO_NAP, ONE_NAP, TRANSITION
  type            String
  isActive        Boolean  @default(true)

  // Wake windows (in minutes)
  wakeWindow1Min  Int      // Wake to Nap 1
  wakeWindow1Max  Int
  wakeWindow2Min  Int?     // Nap 1 end to Nap 2 (null for 1-nap)
  wakeWindow2Max  Int?
  wakeWindow3Min  Int?     // Nap 2 end to Bedtime (null for 1-nap)
  wakeWindow3Max  Int?

  // Nap 1 constraints (HH:mm format)
  nap1Earliest    String?
  nap1LatestStart String?
  nap1MaxDuration Int?     // minutes
  nap1EndBy       String?

  // Nap 2 constraints
  nap2Earliest    String?
  nap2LatestStart String?
  nap2MaxDuration Int?
  nap2EndBy       String?
  nap2ExceptionDuration Int?   // If nap 1 was skipped

  // Bedtime constraints
  bedtimeEarliest  String
  bedtimeLatest    String
  bedtimeGoalStart String?  // Ideal bedtime window start
  bedtimeGoalEnd   String?  // Ideal bedtime window end

  // Wake time constraints
  wakeTimeEarliest String
  wakeTimeLatest   String
  // Must wake by time (hard deadline for morning wake - default 07:30)
  mustWakeBy       String   @default("07:30")

  // Sleep caps
  daySleepCap     Int      // Total day sleep in minutes
  // Individual nap cap in minutes (default 120 = 2 hours)
  napCapMinutes   Int      @default(120)

  // Crib time settings (for naps only - not applicable to bedtime)
  minimumCribMinutes Int   @default(60)  // Minimum time in crib for sleep training

  // Notification settings (lead time in minutes before event)
  napReminderMinutes     Int   @default(30)  // How many minutes before nap time to notify
  bedtimeReminderMinutes Int   @default(30)  // How many minutes before bedtime to notify
  wakeDeadlineReminderMinutes Int @default(15) // How many minutes before wake deadline to notify

  child           Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([childId])
  @@index([childId, isActive])
}

// ScheduleType values: THREE_NAP, TWO_NAP, ONE_NAP, TRANSITION
// - THREE_NAP: 3 naps per day (younger babies)
// - TWO_NAP: 2 naps per day (12-14 months)
// - ONE_NAP: 1 nap per day (14+ months)
// - TRANSITION: In transition between schedules

// ============================================
// Schedule Transitions (2-to-1 nap transition)
// ============================================

model ScheduleTransition {
  id             String   @id @default(uuid())
  childId        String
  // ScheduleType values
  fromType       String
  toType         String
  startedAt      DateTime @default(now())
  currentWeek    Int      @default(1)
  currentNapTime String   // HH:mm - current target single nap time
  completedAt    DateTime?
  notes          String?

  child          Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([childId])
}

// ============================================
// Sleep Session Tracking
// ============================================

model SleepSession {
  id            String   @id @default(uuid())
  childId       String
  // SessionType: NAP, NIGHT_SLEEP
  sessionType   String
  // SessionState: PENDING, ASLEEP, AWAKE, COMPLETED
  state         String
  napNumber     Int?     // 1, 2, or null for night sleep

  // Timestamps (UTC)
  putDownAt     DateTime? // When baby was put in crib
  asleepAt      DateTime? // When baby fell asleep
  wokeUpAt      DateTime? // When baby woke up
  outOfCribAt   DateTime? // When baby was taken out

  // Optional tracking
  cryingMinutes Int?     // For CIO/Ferber tracking
  notes         String?

  // Who logged this entry (for multi-caregiver tracking)
  createdByUserId  String?   // User who created the session
  lastUpdatedByUserId String? // User who last updated the session
  createdByUser    User?     @relation("SessionCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  lastUpdatedByUser User?    @relation("SessionUpdater", fields: [lastUpdatedByUserId], references: [id], onDelete: SetNull)

  // Calculated fields (stored for convenience)
  totalMinutes         Int?     // Total time in crib (putDown to outOfCrib)
  sleepMinutes         Int?     // Actual sleep time (asleep to wokeUp)
  settlingMinutes      Int?     // Time to fall asleep (putDown to asleep)
  postWakeMinutes      Int?     // Time awake after waking (wokeUp to outOfCrib)
  awakeCribMinutes     Int?     // Total awake time in crib (settling + postWake)
  qualifiedRestMinutes Int?     // (awakeCribTime รท 2) + sleepMinutes - sleep training metric

  child         Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([childId])
  @@index([childId, createdAt])
  @@index([childId, sessionType])
  @@index([createdByUserId])
}

// SessionType values: NAP, NIGHT_SLEEP

// SessionState values: PENDING, ASLEEP, AWAKE, COMPLETED
// - PENDING: Put down, not yet asleep
// - ASLEEP: Baby is sleeping
// - AWAKE: Baby woke up, still in crib
// - COMPLETED: Session ended, out of crib
