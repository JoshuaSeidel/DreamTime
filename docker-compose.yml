version: '3.8'

# =============================================================================
# DreamTime - Baby Sleep Tracker
# =============================================================================
# Compatible with Unraid and standard Docker installations
#
# QUICK START (SQLite - no external database required):
#   mkdir -p ./data/secrets ./data/database
#   docker-compose up -d
#
# POSTGRESQL SETUP:
#   1. Set up your PostgreSQL database (external server or container)
#   2. Create the database: CREATE DATABASE dreamtime;
#   3. Configure environment variables below or use .env file
#   4. Run: docker-compose up -d
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # API Server (internal only - proxied via nginx)
  # ---------------------------------------------------------------------------
  server:
    build:
      context: .
      dockerfile: packages/server/Dockerfile
    container_name: dreamtime-server
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000

      # -----------------------------------------------------------------------
      # DATABASE CONFIGURATION
      # -----------------------------------------------------------------------
      # DB_TYPE: "sqlite" (default) or "postgresql"
      #
      # For SQLite (default - no setup required):
      #   DB_TYPE=sqlite
      #   Data stored in: ./data/database/dreamtime.db
      #
      # For PostgreSQL (requires external database):
      #   DB_TYPE=postgresql
      #   DATABASE_URL=postgresql://username:password@hostname:5432/dreamtime
      #
      # Examples:
      #   - Local PostgreSQL: postgresql://dreamtime:secret@host.docker.internal:5432/dreamtime
      #   - Remote PostgreSQL: postgresql://user:pass@db.example.com:5432/dreamtime
      #   - Unraid PostgreSQL: postgresql://user:pass@192.168.1.100:5432/dreamtime
      # -----------------------------------------------------------------------
      DB_TYPE: ${DB_TYPE:-sqlite}
      DATABASE_URL: ${DATABASE_URL:-}

      # -----------------------------------------------------------------------
      # AUTHENTICATION (auto-generated if not provided)
      # -----------------------------------------------------------------------
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}

      # -----------------------------------------------------------------------
      # PUSH NOTIFICATIONS
      # -----------------------------------------------------------------------
      VAPID_SUBJECT: ${VAPID_SUBJECT:-mailto:admin@dreamtime.app}

      # -----------------------------------------------------------------------
      # DATA STORAGE
      # -----------------------------------------------------------------------
      DATA_DIR: /app/data
      SECRETS_DIR: /app/data/secrets

      # -----------------------------------------------------------------------
      # CLIENT URL (required for WebAuthn/Face ID to work)
      # -----------------------------------------------------------------------
      # Set this to the URL users access the app from
      # Examples:
      #   - http://dreamtime.local
      #   - https://dreamtime.yourdomain.com
      #   - http://192.168.1.100
      CLIENT_URL: ${CLIENT_URL:-http://localhost}

      # -----------------------------------------------------------------------
      # WEBAUTHN / FACE ID (optional - derived from CLIENT_URL if not set)
      # -----------------------------------------------------------------------
      # Only set these if you need to override the auto-detected values
      # WEBAUTHN_RP_ID: The hostname only (e.g., "dreamtime.example.com")
      # WEBAUTHN_ORIGIN: Full URL including protocol (e.g., "https://dreamtime.example.com")
      WEBAUTHN_RP_ID: ${WEBAUTHN_RP_ID:-}
      WEBAUTHN_ORIGIN: ${WEBAUTHN_ORIGIN:-}

      # -----------------------------------------------------------------------
      # MQTT / HOME ASSISTANT INTEGRATION (optional)
      # -----------------------------------------------------------------------
      # Enable MQTT for Home Assistant voice control via Alexa
      # Requires a Mosquitto MQTT broker (included below or external)
      MQTT_ENABLED: ${MQTT_ENABLED:-false}
      MQTT_BROKER_URL: ${MQTT_BROKER_URL:-mqtt://mosquitto:1883}
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      MQTT_TOPIC_PREFIX: ${MQTT_TOPIC_PREFIX:-dreamtime}

    # Folder mappings for Unraid compatibility (no named volumes)
    volumes:
      - ./data:/app/data

    # No public ports - only accessible within Docker network via nginx proxy
    expose:
      - "3000"

    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Frontend Client (public facing - serves static files and proxies API)
  # ---------------------------------------------------------------------------
  client:
    build:
      context: .
      dockerfile: packages/client/Dockerfile
    container_name: dreamtime-client
    restart: unless-stopped
    ports:
      - "${PORT:-80}:80"
    depends_on:
      server:
        condition: service_healthy
    networks:
      - default  # dreamtime-network (for server communication)
      - swag     # SWAG network (for reverse proxy)
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  default:
    name: dreamtime-network
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"
  # Connect to SWAG's network for reverse proxy access
  swag:
    external: true
    name: swag_default  # Change this to match your SWAG network name
